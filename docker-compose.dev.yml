services:
  api:
    build:
      dockerfile: Dockerfile
      context: ./api-v2
    # Mount our host dir to the docker container for hot reload
    volumes:
      - ./api-v2:/app
      - ./api-v2/node_modules:/app/node_modules
      - ${UPLOADS_PATH:-~/uploads}:/app/upload
    # Run in development mode with hot reload
    command: npm run start:dev
    depends_on:
     - postgres
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://${POSTGRES_USER:-rgpapp}:${POSTGRES_PASSWORD:-r9pAdmin7}@${DB_HOST:-host.docker.internal}:${DB_PORT:-5432}/${POSTGRES_DB:-rgpdb}
      LOG_SQL: ${LOG_SQL:-true}
      FILEUPLOAD_LOCATION: ${FILEUPLOAD_LOCATION:-/app/upload}
      FILEUPOAD_SIZE_LIMIT: ${FILEUPOAD_SIZE_LIMIT:-512000}
      JWT_KEY: ${JWT_KEY:-dev}
      JWT_EXPIRES: ${JWT_EXPIRES:-24h}
      PORT: ${API_PORT:-3000}
    ports:
      - "${API_PORT:-3000}:${API_PORT:-3000}"
      # Expose debugging port for development
      - "9229:9229"
    networks:
      - dev-network

  postgres:
    image: postgres:17.4-alpine
    restart: always
    container_name: rgp-db-dev
    volumes:
      - pgdata_dev:/var/lib/postgresql/data
      # Mount SQL scripts for easy database initialization
      - ./sql/ddl:/docker-entrypoint-initdb.d
    networks:
      - dev-network
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-rgpapp}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-r9pAdmin7}
      POSTGRES_DB: ${POSTGRES_DB:-rgpdb}
    command:
      - postgres
      - -c
      - shared_buffers=256MB
      - -c
      - effective_cache_size=1GB
      - -c
      - work_mem=16MB
      - -c
      - maintenance_work_mem=128MB
      - -c
      - max_connections=100
      - -c
      - random_page_cost=1.1
      - -c
      - effective_io_concurrency=200
      - -c
      - wal_buffers=16MB
      - -c
      - min_wal_size=1GB
      - -c
      - max_wal_size=4GB
      - -c
      - checkpoint_completion_target=0.9
      - -c
      - default_statistics_target=100
      - -c
      - checkpoint_timeout=15min
      - -c
      - synchronous_commit=off
      - -c
      - wal_compression=on
      - -c
      - log_min_duration_statement=3000
      - -c
      - "log_line_prefix=%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h "
      - -c
      - log_checkpoints=on
      - -c
      - log_connections=on
      - -c
      - log_disconnections=on
      - -c
      - log_lock_waits=on
      - -c
      - log_temp_files=0
    shm_size: 256mb
    ports:
      - "${DB_PORT:-5432}:5432"

  frontend:
    build:
      dockerfile: Dockerfile
      context: ./frontend
    # Note: Volume mounting removed - Angular builds need the built files, not source
    # For live development of frontend, use 'ng serve' locally instead
    ports:
      - "${FRONTEND_PORT:-8000}:80"
    networks:
      - dev-network
    depends_on:
      - api

networks:
  dev-network:
    driver: bridge

volumes:
  pgdata_dev:
    driver: local
