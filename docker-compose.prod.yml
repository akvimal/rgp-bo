
services:
  api:
    build:
      dockerfile: Dockerfile
      context: ./api-v2
    restart: unless-stopped
    volumes:
      - ${UPLOADS_PATH:-~/uploads}:/app/upload
    command: npm run start:prod
    depends_on:
      - postgres
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${DB_HOST:-postgres}:${DB_PORT:-5432}/${POSTGRES_DB}
      LOG_SQL: ${LOG_SQL:-false}
      FILEUPLOAD_LOCATION: ${FILEUPLOAD_LOCATION:-/app/upload}
      FILEUPOAD_SIZE_LIMIT: ${FILEUPOAD_SIZE_LIMIT:-512000}
      JWT_KEY: ${JWT_KEY}
      JWT_EXPIRES: ${JWT_EXPIRES:-24h}
      PORT: ${API_PORT:-3000}
    ports:
      - "${API_PORT:-3000}:${API_PORT:-3000}"
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:${API_PORT:-3000}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  postgres:
    image: postgres:17.4-alpine
    restart: unless-stopped
    container_name: rgp-db
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - app-network
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      # Performance Tuning - Adjust based on your system RAM
      # For 4GB RAM system, allocate ~1GB to PostgreSQL
      POSTGRES_SHARED_BUFFERS: ${PG_SHARED_BUFFERS:-256MB}
      POSTGRES_EFFECTIVE_CACHE_SIZE: ${PG_EFFECTIVE_CACHE_SIZE:-1GB}
      POSTGRES_WORK_MEM: ${PG_WORK_MEM:-16MB}
      POSTGRES_MAINTENANCE_WORK_MEM: ${PG_MAINTENANCE_WORK_MEM:-128MB}
      POSTGRES_MAX_CONNECTIONS: ${PG_MAX_CONNECTIONS:-100}
      POSTGRES_RANDOM_PAGE_COST: ${PG_RANDOM_PAGE_COST:-1.1}
      POSTGRES_EFFECTIVE_IO_CONCURRENCY: ${PG_EFFECTIVE_IO_CONCURRENCY:-200}
      POSTGRES_WAL_BUFFERS: ${PG_WAL_BUFFERS:-16MB}
      POSTGRES_MIN_WAL_SIZE: ${PG_MIN_WAL_SIZE:-1GB}
      POSTGRES_MAX_WAL_SIZE: ${PG_MAX_WAL_SIZE:-4GB}
      POSTGRES_CHECKPOINT_COMPLETION_TARGET: ${PG_CHECKPOINT_COMPLETION_TARGET:-0.9}
    command:
      - postgres
      - -c
      - shared_buffers=256MB
      - -c
      - effective_cache_size=1GB
      - -c
      - work_mem=16MB
      - -c
      - maintenance_work_mem=128MB
      - -c
      - max_connections=100
      - -c
      - random_page_cost=1.1
      - -c
      - effective_io_concurrency=200
      - -c
      - wal_buffers=16MB
      - -c
      - min_wal_size=1GB
      - -c
      - max_wal_size=4GB
      - -c
      - checkpoint_completion_target=0.9
      - -c
      - default_statistics_target=100
      - -c
      - checkpoint_timeout=15min
      - -c
      - synchronous_commit=off
      - -c
      - wal_compression=on
      - -c
      - log_min_duration_statement=5000
      - -c
      - "log_line_prefix=%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h "
      - -c
      - log_checkpoints=on
      - -c
      - log_connections=on
      - -c
      - log_disconnections=on
      - -c
      - log_lock_waits=on
      - -c
      - log_temp_files=0
    shm_size: 256mb
    ports:
      - "${DB_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

  frontend:
    build:
      dockerfile: Dockerfile
      context: ./frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-8000}:80"
    networks:
      - app-network
    depends_on:
      - api
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  app-network:
    driver: bridge

volumes:
  pgdata:
    driver: local
