<div class="card mt-2">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="card-title mb-0">
                <i class="bi bi-lightbulb"></i>
                {{ isViewMode ? 'View' : (isEditMode ? 'Edit' : 'New') }} Sales Intent
            </h5>
            <div *ngIf="isViewMode && intent.status">
                <span [ngClass]="getStatusBadgeClass(intent.status)">
                    {{intent.status}}
                </span>
            </div>
        </div>

        <form [formGroup]="form" (ngSubmit)="submit()">

            <!-- Intent Details Card -->
            <div class="card bg-light mb-3">
                <div class="card-body">
                    <h6 class="card-subtitle mb-3 text-primary">
                        <i class="bi bi-info-circle"></i> Intent Details
                    </h6>

                    <div class="row">
                        <!-- Intent Type -->
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Intent Type <span class="text-danger">*</span></label>
                            <select class="form-select" formControlName="intenttype">
                                <option *ngFor="let type of typeOptions" [value]="type">
                                    {{formatType(type)}}
                                </option>
                            </select>
                            <small class="form-text text-muted">Why is this product needed?</small>
                        </div>

                        <!-- Priority -->
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Priority <span class="text-danger">*</span></label>
                            <select class="form-select" formControlName="priority">
                                <option *ngFor="let priority of priorityOptions" [value]="priority">
                                    {{priority}}
                                </option>
                            </select>
                            <small class="form-text text-muted">Urgency level</small>
                        </div>

                        <!-- Intent Number (view mode only) -->
                        <div class="col-md-3" *ngIf="isEditMode || isViewMode">
                            <label class="form-label fw-bold">Intent Number</label>
                            <input type="text" class="form-control" [value]="intent.intentno" disabled>
                        </div>

                        <!-- Created Date (view mode only) -->
                        <div class="col-md-3" *ngIf="isEditMode || isViewMode">
                            <label class="form-label fw-bold">Created On</label>
                            <input type="text" class="form-control"
                                   [value]="intent.createdon | date:'dd/MM/yyyy HH:mm'" disabled>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Product Details Card -->
            <div class="card bg-light mb-3">
                <div class="card-body">
                    <h6 class="card-subtitle mb-3 text-primary">
                        <i class="bi bi-box"></i> Product Details
                    </h6>

                    <!-- Product Entry Mode Toggle -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm"
                                        [ngClass]="productEntryMode === 'existing' ? 'btn-primary' : 'btn-outline-primary'"
                                        (click)="toggleProductEntryMode('existing')">
                                    <i class="bi bi-list-ul"></i> Select Existing Product
                                </button>
                                <button type="button" class="btn btn-sm"
                                        [ngClass]="productEntryMode === 'manual' ? 'btn-primary' : 'btn-outline-primary'"
                                        (click)="toggleProductEntryMode('manual')">
                                    <i class="bi bi-pencil"></i> Enter Manually
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Existing Product Selection -->
                    <div class="row" *ngIf="productEntryMode === 'existing'">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Search & Select Product <span class="text-danger">*</span></label>

                            <!-- Selected Product Display -->
                            <div *ngIf="selectedProduct" class="alert alert-success d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{selectedProduct.title}}</strong>
                                    <br>
                                    <small class="text-muted">
                                        Code: {{selectedProduct.product_code || 'N/A'}}
                                        | Brand: {{selectedProduct.brand || 'N/A'}}
                                    </small>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-danger" (click)="clearProductSelection()">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            </div>

                            <!-- Product Search -->
                            <div *ngIf="!selectedProduct">
                                <input type="text"
                                       class="form-control"
                                       placeholder="Type to search products..."
                                       [(ngModel)]="productSearchTerm"
                                       [ngModelOptions]="{standalone: true}"
                                       (input)="searchProducts($event)">

                                <!-- Product Dropdown -->
                                <div class="list-group mt-2" style="max-height: 300px; overflow-y: auto;" *ngIf="productSearchTerm && filteredProducts.length > 0">
                                    <button type="button"
                                            class="list-group-item list-group-item-action"
                                            *ngFor="let product of filteredProducts.slice(0, 20)"
                                            (click)="selectProduct(product)">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <strong>{{product.title}}</strong>
                                                <br>
                                                <small class="text-muted">
                                                    {{product.product_code || 'No code'}} | {{product.brand || 'No brand'}}
                                                </small>
                                            </div>
                                            <div class="text-end">
                                                <span class="badge bg-info">{{product.category || 'No category'}}</span>
                                            </div>
                                        </div>
                                    </button>
                                </div>

                                <!-- No Results Message -->
                                <div class="alert alert-warning mt-2" *ngIf="productSearchTerm && filteredProducts.length === 0">
                                    <i class="bi bi-exclamation-triangle"></i> No products found. Try different search terms or use "Enter Manually" option.
                                </div>
                            </div>

                            <small class="form-text text-muted d-block mt-2">
                                Search by product name or code, then select from the list
                            </small>
                        </div>
                    </div>

                    <!-- Manual Product Entry -->
                    <div class="row" *ngIf="productEntryMode === 'manual'">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Product Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" formControlName="productname"
                                   placeholder="Enter product name" maxlength="100">
                            <small class="form-text text-muted">
                                Enter product name manually (for products not in the system)
                            </small>
                            <div *ngIf="form.controls['productname'].dirty && form.controls['productname'].invalid"
                                 class="text-danger small mt-1">
                                <i class="bi bi-exclamation-circle"></i> Product name is required
                            </div>
                        </div>
                    </div>

                    <!-- Quantity and Cost (Common for both modes) -->
                    <div class="row mt-3">
                        <!-- Requested Quantity -->
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Requested Quantity <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" formControlName="requestedqty"
                                   min="1" placeholder="0">
                            <div *ngIf="form.controls['requestedqty'].dirty && form.controls['requestedqty'].invalid"
                                 class="text-danger small mt-1">
                                <i class="bi bi-exclamation-circle"></i> Quantity must be at least 1
                            </div>
                        </div>

                        <!-- Estimated Cost -->
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Estimated Cost (₹)</label>
                            <input type="number" class="form-control" formControlName="estimatedcost"
                                   min="0" step="0.01" placeholder="0.00">
                            <small class="form-text text-muted">Per unit cost estimate</small>
                        </div>
                    </div>

                    <!-- Add Product Button -->
                    <div class="row mt-3" *ngIf="!isViewMode">
                        <div class="col-12">
                            <button type="button" class="btn btn-success" (click)="addItem()">
                                <i class="bi bi-plus-circle"></i> Add Product to Intent
                            </button>
                            <small class="text-muted ms-2">
                                You can add multiple products to this intent
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Items List Card (NEW) -->
            <div class="card bg-light mb-3" *ngIf="intentItems.length > 0">
                <div class="card-body">
                    <h6 class="card-subtitle mb-3 text-primary">
                        <i class="bi bi-list-check"></i> Products Added ({{intentItems.length}})
                    </h6>

                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th style="width: 120px;">Quantity</th>
                                    <th style="width: 120px;">Est. Cost</th>
                                    <th style="width: 120px;">Total</th>
                                    <th style="width: 100px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let item of intentItems; let i = index">
                                    <td>
                                        <strong>{{item.productname}}</strong>
                                        <span class="badge bg-secondary ms-2" *ngIf="item.prodid">ID: {{item.prodid}}</span>
                                    </td>
                                    <td class="text-end">{{item.requestedqty}}</td>
                                    <td class="text-end">₹{{item.estimatedcost || 0 | number:'1.2-2'}}</td>
                                    <td class="text-end"><strong>₹{{(item.estimatedcost || 0) * item.requestedqty | number:'1.2-2'}}</strong></td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-sm btn-outline-primary me-1" (click)="editItem(i)" [disabled]="isViewMode">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeItem(i)" [disabled]="isViewMode">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr class="table-active">
                                    <td colspan="3" class="text-end"><strong>Total Estimated Cost:</strong></td>
                                    <td class="text-end"><strong>₹{{getTotalEstimatedCost() | number:'1.2-2'}}</strong></td>
                                    <td></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Customer Details Card (Optional) -->
            <div class="card bg-light mb-3">
                <div class="card-body">
                    <h6 class="card-subtitle mb-3 text-primary">
                        <i class="bi bi-person"></i> Customer Details (Optional)
                    </h6>

                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle"></i>
                        <strong>Customer Requests:</strong> If this intent is for a specific customer request,
                        enter customer details below. Customer will be notified when product arrives.
                    </div>

                    <div class="row">
                        <!-- Customer Name -->
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Customer Name</label>
                            <input type="text" class="form-control" formControlName="customername"
                                   placeholder="Enter customer name" maxlength="100">
                        </div>

                        <!-- Customer Mobile -->
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Customer Mobile</label>
                            <input type="text" class="form-control" formControlName="customermobile"
                                   placeholder="Enter mobile number" maxlength="15">
                            <div *ngIf="form.controls['customermobile'].dirty && form.controls['customermobile'].invalid"
                                 class="text-danger small mt-1">
                                <i class="bi bi-exclamation-circle"></i> Only numbers allowed
                            </div>
                        </div>

                        <!-- Advance Amount -->
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Advance Amount (₹)</label>
                            <input type="number" class="form-control" formControlName="advanceamount"
                                   min="0" step="0.01" placeholder="0.00">
                            <small class="form-text text-muted">Customer advance payment</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notes Card -->
            <div class="card bg-light mb-3">
                <div class="card-body">
                    <h6 class="card-subtitle mb-3 text-primary">
                        <i class="bi bi-chat-text"></i> Notes
                    </h6>

                    <div class="row">
                        <!-- Request Notes -->
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Request Notes</label>
                            <textarea class="form-control" formControlName="requestnotes" rows="3"
                                      placeholder="Why is this product needed? Any specific requirements?"></textarea>
                            <small class="form-text text-muted">Reason for the request</small>
                        </div>

                        <!-- Internal Notes -->
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Internal Notes</label>
                            <textarea class="form-control" formControlName="internalnotes" rows="3"
                                      placeholder="Internal notes for purchase staff"></textarea>
                            <small class="form-text text-muted">For purchase team reference</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Display (View/Edit Mode) -->
            <div class="card bg-light mb-3" *ngIf="(isEditMode || isViewMode) && intent">
                <div class="card-body">
                    <h6 class="card-subtitle mb-3 text-primary">
                        <i class="bi bi-activity"></i> Status Information
                    </h6>

                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Status</label>
                            <div>
                                <span [ngClass]="getStatusBadgeClass(intent.status)">
                                    {{intent.status || 'PENDING'}}
                                </span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Fulfillment Status</label>
                            <div>{{intent.fulfillmentstatus || 'NOT_STARTED'}}</div>
                        </div>
                        <div class="col-md-3" *ngIf="intent.purchaseorderid">
                            <label class="form-label fw-bold">Purchase Order</label>
                            <div>
                                <a [routerLink]="['/secure/purchases/orders/edit', intent.purchaseorderid]">
                                    PO #{{intent.purchaseorderid}}
                                </a>
                            </div>
                        </div>
                        <div class="col-md-3" *ngIf="intent.fulfilledon">
                            <label class="form-label fw-bold">Fulfilled On</label>
                            <div>{{intent.fulfilledon | date:'dd/MM/yyyy'}}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div class="alert alert-danger" *ngIf="errorMessage">
                <i class="bi bi-exclamation-triangle-fill"></i> {{errorMessage}}
            </div>

            <!-- Action Buttons -->
            <div class="row mt-4">
                <div class="col-md-12 d-flex gap-2">
                    <button type="submit" class="btn btn-primary px-4"
                            [disabled]="!form.valid || loading || isViewMode">
                        <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
                        <i class="bi bi-check-circle"></i>
                        {{ isEditMode ? 'Update Intent' : 'Create Intent' }}
                    </button>
                    <button type="button" (click)="reset()" class="btn btn-outline-secondary px-4"
                            [disabled]="loading || isViewMode">
                        <i class="bi bi-arrow-counterclockwise"></i> Reset
                    </button>
                    <button type="button" (click)="gotoList()" class="btn btn-outline-secondary px-4">
                        <i class="bi bi-arrow-left"></i> Back to List
                    </button>
                </div>
            </div>

        </form>
    </div>
</div>
