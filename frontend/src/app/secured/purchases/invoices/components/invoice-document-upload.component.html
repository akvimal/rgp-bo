<div class="card mt-3">
  <div class="card-body">
    <h6 class="card-title">
      <i class="bi bi-cloud-upload"></i> Upload Invoice Document for Auto-Extraction
    </h6>
    <p class="text-muted small">
      Upload an invoice PDF or image to automatically extract and populate invoice details
    </p>

    <!-- Upload Area -->
    <div class="row">
      <div class="col-md-8">
        <div class="upload-area"
             [class.dragover]="isDragover"
             (dragover)="onDragOver($event)"
             (dragleave)="onDragLeave($event)"
             (drop)="onDrop($event)">

          <div class="text-center p-4" *ngIf="!selectedFile && !uploading && !extractedData">
            <i class="bi bi-cloud-arrow-up" style="font-size: 3rem; color: #6c757d;"></i>
            <p class="mt-2">Drag and drop invoice file here or</p>
            <input type="file"
                   #fileInput
                   (change)="onFileSelected($event)"
                   accept="image/*,application/pdf"
                   style="display: none;">
            <button type="button" class="btn btn-primary" (click)="fileInput.click()">
              <i class="bi bi-file-earmark-arrow-up"></i> Choose File
            </button>
            <p class="text-muted small mt-2">Supported formats: PDF, JPG, PNG (Max 10MB)</p>
          </div>

          <!-- Selected File Info -->
          <div class="selected-file-info p-3" *ngIf="selectedFile && !uploading">
            <div class="d-flex align-items-center justify-content-between">
              <div class="d-flex align-items-center">
                <i class="bi bi-file-earmark-pdf fs-2 text-danger me-3" *ngIf="selectedFile.type === 'application/pdf'"></i>
                <i class="bi bi-file-earmark-image fs-2 text-primary me-3" *ngIf="selectedFile.type.startsWith('image/')"></i>
                <div>
                  <strong>{{selectedFile.name}}</strong>
                  <br>
                  <small class="text-muted">{{formatFileSize(selectedFile.size)}}</small>
                </div>
              </div>
              <div>
                <button type="button" class="btn btn-success me-2" (click)="uploadAndExtract()">
                  <i class="bi bi-magic"></i> Extract Data
                </button>
                <button type="button" class="btn btn-outline-secondary" (click)="clearFile()">
                  <i class="bi bi-x"></i> Remove
                </button>
              </div>
            </div>
          </div>

          <!-- Uploading Progress -->
          <div class="uploading-progress p-4 text-center" *ngIf="uploading">
            <div class="spinner-border text-primary mb-3" role="status">
              <span class="visually-hidden">Uploading...</span>
            </div>
            <p><strong>Processing Invoice...</strong></p>
            <p class="text-muted small">Uploading and extracting data from document</p>
            <div class="progress" style="height: 25px;">
              <div class="progress-bar progress-bar-striped progress-bar-animated"
                   role="progressbar"
                   [style.width]="uploadProgress + '%'">
                {{uploadProgress}}%
              </div>
            </div>
          </div>

          <!-- Extracted Data Preview -->
          <div class="extracted-data-preview p-3" *ngIf="extractedData && !uploading">
            <div class="alert alert-success d-flex align-items-center mb-3">
              <i class="bi bi-check-circle-fill fs-4 me-2"></i>
              <div>
                <strong>Data Extracted Successfully!</strong>
                <br>
                <small>Review the extracted data below and click "Populate Form" to fill the invoice form.</small>
              </div>
            </div>

            <!-- Extracted Invoice Data -->
            <div class="row">
              <div class="col-md-6 mb-2">
                <label class="form-label fw-bold">Invoice Number:</label>
                <input type="text" class="form-control" [(ngModel)]="extractedData.invoice.invoiceNumber"
                       placeholder="Not detected">
              </div>
              <div class="col-md-6 mb-2">
                <label class="form-label fw-bold">Invoice Date:</label>
                <input type="date" class="form-control" [(ngModel)]="extractedData.invoice.invoiceDate">
              </div>
              <div class="col-md-6 mb-2">
                <label class="form-label fw-bold">Vendor Name:</label>
                <input type="text" class="form-control" [(ngModel)]="extractedData.invoice.vendorName"
                       placeholder="Not detected">
              </div>
              <div class="col-md-6 mb-2">
                <label class="form-label fw-bold">GR Number:</label>
                <input type="text" class="form-control" [(ngModel)]="extractedData.invoice.grNumber"
                       placeholder="Not detected">
              </div>
              <div class="col-md-4 mb-2">
                <label class="form-label fw-bold">Subtotal:</label>
                <input type="number" class="form-control" [(ngModel)]="extractedData.invoice.subtotal"
                       placeholder="0.00" step="0.01">
              </div>
              <div class="col-md-4 mb-2">
                <label class="form-label fw-bold">Tax Amount:</label>
                <input type="number" class="form-control" [(ngModel)]="extractedData.invoice.taxAmount"
                       placeholder="0.00" step="0.01">
              </div>
              <div class="col-md-4 mb-2">
                <label class="form-label fw-bold">Total Amount:</label>
                <input type="number" class="form-control" [(ngModel)]="extractedData.invoice.totalAmount"
                       placeholder="0.00" step="0.01">
              </div>
            </div>

            <!-- Extracted Items (if any) -->
            <div class="mt-3" *ngIf="extractedData.items && extractedData.items.length > 0">
              <h6 class="fw-bold">Extracted Line Items: ({{extractedData.items.length}})</h6>
              <div class="alert alert-info small">
                <i class="bi bi-info-circle"></i> Line items detected. These will be added after populating the invoice.
              </div>
            </div>

            <!-- Notes/Warnings -->
            <div class="mt-3" *ngIf="extractedData.notes && extractedData.notes.length > 0">
              <div class="alert alert-warning small mb-1" *ngFor="let note of extractedData.notes">
                <i class="bi bi-exclamation-triangle"></i> {{note}}
              </div>
            </div>

            <!-- Confidence Score -->
            <div class="mt-3" *ngIf="extractedData.confidence">
              <small class="text-muted">
                <i class="bi bi-speedometer2"></i> Extraction Confidence:
                <span [class]="getConfidenceClass(extractedData.confidence)">
                  {{extractedData.confidence}}%
                </span>
              </small>
            </div>

            <!-- Action Buttons -->
            <div class="mt-3 d-flex justify-content-between">
              <button type="button" class="btn btn-outline-secondary" (click)="clearAll()">
                <i class="bi bi-x-circle"></i> Cancel
              </button>
              <button type="button" class="btn btn-primary" (click)="populateForm()">
                <i class="bi bi-arrow-down-circle"></i> Populate Form
              </button>
            </div>
          </div>

          <!-- Error Message -->
          <div class="alert alert-danger mt-3" *ngIf="errorMessage">
            <i class="bi bi-exclamation-triangle"></i> {{errorMessage}}
            <button type="button" class="btn-close float-end" (click)="errorMessage = ''"></button>
          </div>
        </div>
      </div>

      <!-- Help/Info Panel -->
      <div class="col-md-4">
        <div class="card bg-light">
          <div class="card-body">
            <h6 class="card-title"><i class="bi bi-info-circle"></i> How it works</h6>
            <ol class="small mb-0">
              <li>Upload your invoice document (PDF or image)</li>
              <li>AI will automatically extract key details</li>
              <li>Review and edit the extracted data</li>
              <li>Click "Populate Form" to fill the invoice</li>
            </ol>
            <hr>
            <h6 class="card-title"><i class="bi bi-lightbulb"></i> Tips</h6>
            <ul class="small mb-0">
              <li>Use clear, high-quality scans</li>
              <li>Ensure text is readable</li>
              <li>Review extracted data before populating</li>
              <li>Manually edit any incorrect values</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
