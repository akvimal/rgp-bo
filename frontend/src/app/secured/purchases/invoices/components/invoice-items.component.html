<div class="pagetitle">
    <h1>Purchase Invoices</h1>
  </div>
  
  <div class="card">
    <div class="card-body">
        <div class="row">
            <div class="col-lg-4 col-md-4 label">Vendor: {{invoice.vendor?.name}}</div>
            <div class="col-lg-4 col-md-4 label">Invoice No: {{invoice.invoiceno}}</div>
            <div class="col-lg-4 col-md-4 label">Invoice Date: {{invoice.invoicedate | date : 'dd/MM/yyyy'}}</div>
        </div>
        <div class="row">
            <div class="col-lg-4 col-md-4 label">PO ID: {{invoice.purchaseorderid}}</div>
            <!-- <div class="col-lg-4 col-md-4 label">GRN: {{invoice.grn}}</div> -->
            <div class="col-lg-4 col-md-4 label">Status: {{invoice.status}}</div>
        </div>
        <a *ngIf="invoice.status === 'NEW'" [routerLink]="['../../edit',invoice.id]">Edit</a>
    </div>
</div>
<div class="card" *ngIf="invoice.status === 'NEW'">
    <div class="card-body">

<!-- <app-invoice-item-form [invoice]="invoice" *ngIf="invoice.status !== 'RECEIVED'" (addedItem)="onItemAdd($event)"></app-invoice-item-form> -->
        
            <form class="mt-3" [formGroup]="form" (ngSubmit)="submit()">
                <div class="row">
                    <div class="col-md-12">
                        <p-autoComplete formControlName="productid" [showEmptyMessage]="true" field="title" 
                            placeholder="Enter minimum 2 characters to search Product "
                            [suggestions]="filteredProducts" (completeMethod)="filterProduct($event)" type="search"
                            (onSelect)="selected($event)" [minLength]="2" [size]="40"
                            [inputStyle]="{'background-color':'#9df'}">
                                <ng-template let-product pTemplate="item">
                                    <h6 class="m-0">{{product.title}}</h6>
                                        <span style="color:red;font-style: italic;">{{product.props?.composition}}</span>
                                        <p class="m-0"><span style="color:blue;">{{product.props?.mfr}}</span></p>
                                </ng-template>
                        </p-autoComplete>
                    <br>
                    <strong>{{selectedProduct?.title}}</strong><br>
                    <span style="font-style: italic;color:red;">{{selectedProduct?.props?.composition}}</span>
                    </div>
                           <div class="col-md-12">
                            <ul style="background-color:ivory;font-size:small">
                                <li>Enter value in QTY in multiples on one sellable item</li>
                                <li>Enter value in PTR & MRP for one sellable item</li>
                            </ul>
                            
                           </div>     
                    <!-- <div class="col-md-3">
                        <label for="batch" class="form-label">Product</label><br>
                        <strong>{{selectedProduct?.title}}</strong><br>
                        <span style="font-style: italic;color:red;">{{selectedProduct?.props?.composition}}</span>
                    </div>     -->
                <div class="col-md-1">
                    <label for="batch" class="form-label">Batch</label>
                    <input id="batch" type="text" class="form-control" formControlName="batch" size="8">
                </div>
                <div class="col-md-1">
                    <label for="expdate" class="form-label">Expiry</label><br>
                    <p-calendar formControlName="expdate" view="month" dateFormat="mm/yy" [minDate]="minExpDate()"
                    [yearNavigator]="true" yearRange="2000:2030"></p-calendar>
                </div>
                <div class="col-md-1">
                    <label for="mrp" class="form-label">MRP</label>
                    <input type="number" id="mrp" class="form-control" formControlName="mrpcost" (input)="calculate()">
                </div>
                <!-- </div>
                <div class="row"> -->
                    <div class="col-md-1">
                        <label for="qty" class="form-label">QTY</label>
                        <input type="number" id="qty" class="form-control" formControlName="qty" (input)="calculate()">
                    </div>
                    <div class="col-md-1">
                        <label for="ptr" class="form-label">PTR</label>
                        <input type="number" id="ptr" class="form-control" formControlName="ptrcost" size="6" (input)="calculate()">
                        
                    </div>
                    <!-- <div class="col-md-1">
                        <label for="disc" class="form-label">Disc %</label>
                        <input type="text" id="disc" class="form-control" formControlName="discpcnt" size="6" (input)="calculate()">
                    </div> -->
                    <div class="col-md-1">
                        <label for="taxpcnt" class="form-label">Tax %</label>
                        <input type="number" id="taxpcnt" class="form-control" formControlName="taxpcnt" size="4" (input)="calculate()">
                    </div>
                    <!-- <div class="col-md-1">
                        <label for="total" class="form-label" style="color: blue">Free</label>
                        <input type="number" class="form-control">
                    </div>
                    <div class="col-md-1">
                        <label for="disc" class="form-label" style="color: blue">Disc %</label>
                        <input type="number" id="disc" class="form-control" formControlName="discpcnt" size="6" (input)="calculate()">
                    </div> -->
                    <!-- <div class="col-md-1">
                        <label for="disc" class="form-label">Adj Qty</label>
                        
                    </div> -->
                    <div class="col-md-1">
                        <label for="total" class="form-label">Total</label>
                        <br>
                        <span>{{total || 0}}</span>
                    </div>
                </div>
                    <div class="row mt-3">
                        <!-- <div class="col-md-1">
                            <label for="disc" class="form-label">Adj PTR</label> 
                        </div> -->
                        <div class="col-md-1">
                            <label for="salep" class="form-label">Sale</label>
                            <input type="number" id="saleprice" class="form-control" 
                            formControlName="saleprice" (input)="calculateMargin()">
                            <a (click)="calculate()">
                                <i class="bi bi-pin-angle-fill text-danger"></i>
                                </a>
                            <!-- <br>
                            <span>{{form.value.saleprice || 0}}</span> -->
                        </div>
                        <div class="col-md-1">
                            <label for="sellermargin" class="form-label">Margin</label>
                            <br>
                            <!-- <input type="number" id="sellermargin" class="form-control" formControlName="sellermargin" 
                            (input)="adjustSellerMargin()"> -->
                            <span>{{form.value.sellermargin}}%</span>
                        </div>
                        <div class="col-md-1">
                            <label for="custdisc" class="form-label">Discount</label>
                            <br>
                            <!-- <input type="number" id="custsaving" class="form-control" formControlName="customersaving" (input)="adjustSavingMargin($event)"> -->
                            <span>{{form.value.customersaving}}%</span>
                        </div>
                </div>
                <div class="row" *ngIf="form.errors">
                    <p *ngIf="form.get('ptrcost')?.hasError('ptrcostsalesameerror')">Sale Price & PTR same</p>
                </div>
            <div class="row mt-3">
                <div class="col-lg-12">
                    <button type="submit" class="btn btn-primary" [disabled]="!form.valid">Add</button>
                </div>
            </div>
        </form>
    </div></div>
    <div class="card">
        <div class="card-body">
    
        <div class="row mt-3">
            <div class="col-lg-12">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Product</th>
                            <th>Batch</th>
                            <th>Exp Date</th>
                            <th>MRP</th>
                            <th>Qty</th>
                            <th>PTR</th>
                            <th>Disc</th>
                            <th>Tax</th>
                            <th>Total</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                <tbody>
                        <tr *ngFor="let i of invoice.items">
                            <td style="width:2em">
                                <input type="checkbox" *ngIf="i.status !== 'VERIFIED'" (change)="selectItem($event,i.id)">
                            </td>
                            <td>{{i.product?.title}}</td>
                            <td>{{i.batch}}</td>
                            <td>{{i.expdate | date: 'MMM-yy'}}</td>
                            <td style="text-align: right;">{{i.mrpcost}}</td>
                            <td style="text-align: right;">{{i.qty}}</td>
                            <td style="text-align: right;">{{i.ptrcost}}</td>
                            <td>{{i.discpcnt}}%</td>
                            <td>{{i.taxpcnt}}%</td>
                            <td style="text-align: right;">{{i.total}}</td>
                            <td>{{i.status}}</td>
                        </tr>
                        <tr>
                            <!-- <td colspan="4">{{invoice.items?.length}} Items</td> -->
                            <td colspan="9" style="text-align: right;">Total ({{invoice.items?.length}} Items)</td>
                            <td style="text-align: right;">{{invoice.total}}</td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12">
                <button type="button" *ngIf="itemSelected" class="btn btn-primary m-2" (click)="verifyItems()">Verify</button>
                <button type="button" *ngIf="itemSelected" class="btn btn-outline-primary m-2" (click)="removeItems()">Remove</button>
            </div>
        </div>
        </div></div>
<div class="card">
    <div class="card-body">
        <div class="row" *ngIf="allVerified && invoice.status === 'NEW'">
            <div class="col-lg-6">
                <label for="grn" class="col-sm-2 col-form-label">GRN</label>
                <input type="text" id="grn" class="form-control" name="grn" [value]="grn"  (change)="updateGrn($event)">
            </div>
            <div class="col-lg-6">
                <label for="feedback">Comments</label>
                <textarea name="feedback" [value]="feedback" (change)="updateFeedback($event)" 
                id="feedback"  class="form-control" cols="30" rows="10"></textarea>
            </div>
            <div class="col-lg-12 mt-2">
                <button type="button" class="btn btn-primary"  (click)="confirmInvoice()">Complete</button>
            </div>
        </div>
        <div *ngIf="invoice.status === 'RECEIVED'">
            GRN: {{invoice.grn}}
        </div>
    </div>
</div>
        <app-invoice-payment *ngIf="invoice.status === 'RECEIVED'" 
            [invoiceid]="invoice.id" [invoiceamt]="invoice.total"
            (payUpdated)="onPaid($event)"></app-invoice-payment>

        <div class="row" *ngIf="invoice.status === 'PAID'">
            <div class="col-lg-12">
                <h5>Payment Info</h5>
                <ul>
                    <li>Date: {{invoice.paydate}}</li>
                    <li>Mode: {{invoice.paydate}}</li>
                    <li>Amount: {{invoice.payamount}}</li>
                    <li>Ref #: {{invoice.payrefno}}</li>
                    <li>Comments: {{invoice.paycomments}}</li>
                </ul>
            </div>
        </div>
