
<div class="card">
    <div class="card-body">
        <div class="row mb-3">
            <div class="col-lg-12 col-md-12 label text-center h4">{{invoice.vendor?.name}}</div>
        </div>
        <div class="row">
            <div class="col-lg-3 col-md-3 label"><strong>Invoice No:</strong> {{invoice.invoiceno}}</div>
            <div class="col-lg-3 col-md-3 label"><strong>Invoice Date:</strong> {{invoice.invoicedate | date : 'dd/MM/yyyy'}}</div>
            <div class="col-lg-3 col-md-3 label text-end"><strong>GRN:</strong><span class="text-success"> {{invoice.grno}}</span></div>
            <div class="col-lg-3 col-md-3 label text-end"><strong>Status:</strong> {{invoice.status}}
                <a [routerLink]="['../../edit',invoice.id]" class="ms-2">Edit</a>
            </div>
        </div>

        <!-- Phase 3: Status Badges -->
        <div class="row mt-3">
            <div class="col-12">
                <app-invoice-status-badges
                    [docType]="invoice.doctype"
                    [paymentStatus]="invoice.paymentstatus"
                    [taxStatus]="invoice.taxstatus"
                    [lifecycleStatus]="invoice.lifecyclestatus">
                </app-invoice-status-badges>
            </div>
        </div>

    </div>
</div>
<div class="card p-0" *ngIf="invoice.status === 'NEW'">
    <div class="card-body">
            <app-invoice-item-form [invoiceid]="invoice.id" (added)="fetchItems($event)"></app-invoice-item-form>
        </div>
    </div>
    <div class="card">
        <div class="card-body">
            <div class="row">
                <div class="col-12">
                    Import
                </div>
            </div>
        <div class="row">
            <div class="col-lg-12">
                <p-table [value]="items" 
                    [resizableColumns]="true" columnResizeMode="expand" styleClass="p-datatable-gridlines mt-0">
                <ng-template pTemplate="header">
                        <tr>
                            <th *ngIf="invoice.status !== 'COMPLETE'"></th>
                            <th *ngIf="invoice.status !== 'COMPLETE'"></th>
                            <th>Type</th>
                            <th pSortableColumn="product.title">Product
                                <p-sortIcon field="product.title"></p-sortIcon>
                            </th>
                            <th>Batch</th>
                            <th pSortableColumn="expdate" class="text-center">Expiry
                                <p-sortIcon field="expdate"></p-sortIcon>
                            </th>
                            <th class="text-end">MRP</th>
                            <th class="text-end">QTY</th>
                            <th class="text-end">Free</th>
                            <th class="text-end">Rate</th>
                            <th class="text-end">Disc</th>
                            <th class="text-end">Tax</th>
                            <th class="text-end">Total</th>
                        </tr>
                    <!-- </thead>
                <tbody> -->
                </ng-template>
                <ng-template pTemplate="body" let-i>
                    <!-- <tr *ngFor="let i of invoice.items"> -->
                        <tr [ngStyle]="{'background':i.selected ? '#ddd' : 'inherit'}">
                            <td *ngIf="invoice.status !== 'COMPLETE'" class="text-center"  style="width:2em">
                                <input type="checkbox" class="form-conrol-input checkmark" *ngIf="i.status === 'NEW'" (change)="selectItem($event,i.id)">
                            </td>
                            <td *ngIf="invoice.status !== 'COMPLETE'" class="text-center" style="width:2em">
                                <h4 style="margin:0;padding:0;">
                                    <a (click)="showItemEdit(i.id)" *ngIf="i.status == 'NEW'">
                                        <i class="bi bi-pencil-square text-primary"></i>
                                    </a>
                                </h4>
                            </td>
                            <td>
                                <select *ngIf="i.status === 'NEW' && invoice.status !== 'COMPLETE'"
                                        class="form-select form-select-sm"
                                        [value]="i.itemtype || 'REGULAR'"
                                        (change)="updateItemType(i.id, $event)">
                                    <option value="REGULAR">Regular</option>
                                    <option value="RETURN">Return</option>
                                    <option value="SUPPLIED">Supplied</option>
                                </select>
                                <span *ngIf="i.status !== 'NEW' || invoice.status === 'COMPLETE'">
                                    <span *ngIf="!i.itemtype || i.itemtype === 'REGULAR'" class="badge bg-success">REG</span>
                                    <span *ngIf="i.itemtype === 'RETURN'" class="badge bg-danger">RET</span>
                                    <span *ngIf="i.itemtype === 'SUPPLIED'" class="badge bg-info">SUP</span>
                                </span>
                            </td>
                            <td>{{i.product?.title}}</td>
                            <td>{{i.batch}}</td>
                            <!-- <td class="text-center">{{i.mfrdate | date: 'MMM-yy'}}</td> -->
                            <td class="text-center">{{i.expdate | date: 'MMM-yy'}}</td>
                            <td class="text-end">{{i.mrpcost | number:'1.2-2'}}</td>
                            <!-- <td style="text-align: right;">{{i.product.pack}}</td> -->
                            <td class="text-end">{{i.qty}}</td>
                            <td class="text-end">{{i.freeqty}}</td>
                            <td class="text-end">{{i.ptrvalue | number:'1.2-2'}}</td>
                            <td class="text-end">{{i.discpcnt}}<span *ngIf="i.discpcnt">%</span></td>
                            <td class="text-end">{{i.taxpcnt}}<span *ngIf="i.taxpcnt">%</span></td>
                            <td class="text-end">{{calculateItemTotal(i) | number:'1.2-2'}}</td>
                            <!-- <td class="text-center">{{i.status}}</td> -->
                        </tr>
                        <!-- Conditional fields for RETURN and SUPPLIED items -->
                        <tr *ngIf="(i.itemtype === 'RETURN' || i.itemtype === 'SUPPLIED') && i.status === 'NEW' && invoice.status !== 'COMPLETE'"
                            style="background-color: #fffacd;">
                            <td *ngIf="invoice.status !== 'COMPLETE'"></td>
                            <td *ngIf="invoice.status !== 'COMPLETE'"></td>
                            <td [attr.colspan]="invoice.status !== 'COMPLETE' ? '11' : '11'">
                                <div class="row g-2 p-2">
                                    <!-- Return Reason (for RETURN items) -->
                                    <div class="col-md-6" *ngIf="i.itemtype === 'RETURN'">
                                        <label class="form-label text-danger fw-bold">
                                            <i class="bi bi-arrow-return-left"></i> Return Reason *
                                        </label>
                                        <input type="text" class="form-control form-control-sm"
                                               [value]="i.returnreason || ''"
                                               (change)="updateItemField(i.id, 'returnreason', $event)"
                                               placeholder="e.g., Damaged, Expired, Wrong item, etc.">
                                        <small class="text-muted">Specify why this item is being returned</small>
                                    </div>

                                    <!-- Challan Reference (for SUPPLIED items) -->
                                    <div class="col-md-6" *ngIf="i.itemtype === 'SUPPLIED'">
                                        <label class="form-label text-info fw-bold">
                                            <i class="bi bi-file-text"></i> Delivery Challan Reference *
                                        </label>
                                        <input type="text" class="form-control form-control-sm"
                                               [value]="i.challanref || ''"
                                               (change)="updateItemField(i.id, 'challanref', $event)"
                                               placeholder="Enter challan number">
                                        <small class="text-muted">Reference to the original delivery challan</small>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        <!-- <tr>
                        
                            <td colspan="9" style="text-align: right;">Total ({{invoice.items?.length}} Items)</td>
                            <td style="text-align: right;">{{invoice.total}}</td>
                            <td></td>
                        </tr> -->
                    <!-- </tbody>
                </table> -->

                </ng-template>
                <ng-template pTemplate="footer">
                    <tr>
                        <td *ngIf="invoice.status !== 'COMPLETE'"></td>
                        <td *ngIf="invoice.status !== 'COMPLETE'"></td>
                        <td colspan="8"></td>
                        <td class="text-end">{{disctotal | number:'1.2-2'}}</td>
                        <td class="text-end">{{taxtotal | number:'1.2-2'}}</td>
                        <td class="text-end">{{nettotal | number:'1.2-2'}}</td>
                    </tr>
                    <tr>
                        <td *ngIf="invoice.status !== 'COMPLETE'"></td>
                        <td *ngIf="invoice.status !== 'COMPLETE'"></td>
                        <td colspan="8" class="text-end">{{invoice.items?.length}} Items</td>
                        <td colspan="3" class="text-end">
                            <span style="color:blue;font-size:larger">{{nettotal | number:'1.2-2'}}</span></td>
                    </tr>
                </ng-template>
            </p-table>
            </div>
            <!-- <div class="col-lg-12">
                Total ({{invoice.items?.length}} items) Gross: {{grosstotal | number:'1.2-2'}} | Disc: {{disctotal | number:'1.2-2'}} | Tax: {{taxtotal | number:'1.2-2'}} | Net: {{nettotal | number:'1.2-2'}} 
            </div> -->
        </div>

        <div class="row">
            <div class="col-lg-12">
                <button type="button" *ngIf="itemSelected" class="btn btn-primary m-2" (click)="verifyItems()">Verify</button>
                <button type="button" *ngIf="itemSelected" class="btn btn-outline-primary m-2" (click)="removeItems()">Remove</button>
            </div>
        </div>
        <!-- </div></div> -->
<!-- <div class="card">
    <div class="card-body"> -->
        <div class="row mt-4" *ngIf="allVerified && invoice.status === 'NEW'">
            <!-- <div class="col-lg-6">
                <label for="grn" class="col-sm-2 col-form-label">GRN</label>
                <input type="text" id="grn" class="form-control" name="grn" [value]="grn"  (change)="updateGrn($event)">
            </div> -->
            <div class="col-lg-6">
                <label for="feedback">Comments</label>
                <textarea name="feedback" [value]="feedback" (change)="updateFeedback($event)" 
                id="feedback"  class="form-control" cols="30" rows="2"></textarea>
            </div>
            <div class="col-lg-12 mt-2">
                <button type="button" class="btn btn-primary"  (click)="confirmInvoice()">Complete</button>
            </div>
        </div>
        <!-- <div *ngIf="invoice.status === 'RECEIVED'">
            GRN: {{invoice.grn}}
        </div> -->
    </div>
</div>

<!-- Payment Management (for COMPLETE invoices) -->
<app-invoice-payment *ngIf="invoice.status === 'COMPLETE'"
    [invoiceId]="invoice.id"
    [vendorId]="invoice.vendorid"
    [invoiceTotal]="invoice.total"
    [docType]="invoice.doctype"
    (paymentUpdated)="onPaid($event)">
</app-invoice-payment>

<!-- Tax Credit Reconciliation (for COMPLETE invoices) -->
<app-invoice-tax-credit *ngIf="invoice.status === 'COMPLETE'"
    [invoiceId]="invoice.id"
    [vendorGstin]="invoice.vendor?.gstin"
    [invoiceTotal]="nettotal"
    [taxAmount]="taxtotal"
    (taxUpdated)="onTaxUpdated($event)">
</app-invoice-tax-credit>

<!-- Invoice Lifecycle Summary & Closure (for COMPLETE invoices) -->
<app-invoice-lifecycle-summary *ngIf="invoice.status === 'COMPLETE'"
    [invoiceId]="invoice.id"
    (lifecycleUpdated)="onLifecycleUpdated($event)">
</app-invoice-lifecycle-summary>

        <p-dialog [header]="'Edit Item'" (onHide)="closeEditItem()"
        [(visible)]="displayEditItem" [modal]="true">
            <app-invoice-item-form [mode]="'edit'" [invoiceid]="invoice.id" [itemid]="itemid" 
            (added)="closeEditItem()"></app-invoice-item-form>
        </p-dialog>