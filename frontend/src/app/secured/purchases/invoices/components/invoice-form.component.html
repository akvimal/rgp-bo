
<div class="card mt-2">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h5 class="card-title p-0 m-0">
        <i class="bi bi-file-earmark-text"></i> {{ invoice.id ? 'Edit' : 'New' }} Invoice
      </h5>
      <!-- Status Badges (shown when editing) -->
      <div *ngIf="invoice.id">
        <app-invoice-status-badges
          [docType]="invoice.doctype"
          [paymentStatus]="invoice.paymentstatus"
          [taxStatus]="invoice.taxstatus"
          [lifecycleStatus]="invoice.lifecyclestatus">
        </app-invoice-status-badges>
      </div>
    </div>

<form [formGroup]="form" (ngSubmit)="submit()">

    <!-- Section 1: Purchase Order (Optional - but first) -->
    <div class="card bg-light mb-3" *ngIf="!invoice.id">
      <div class="card-body">
        <h6 class="card-subtitle mb-3 text-primary">
          <i class="bi bi-cart-check"></i> Step 1: Link to Purchase Order (Optional)
        </h6>

        <div class="alert alert-info mb-3">
          <i class="bi bi-info-circle"></i>
          <strong>Invoice against PO:</strong> If this invoice is for an existing Purchase Order,
          select it below to automatically fetch vendor and other details. Otherwise, skip this step.
        </div>

        <div class="row">
          <div class="col-md-6">
            <label for="poid" class="form-label fw-bold">Purchase Order</label>
            <select class="form-select" id="order" formControlName="purchaseorderid"
                    (change)="onPurchaseOrderChange($event)">
              <option value="">-- No PO (Create Standalone Invoice) --</option>
              <option *ngFor="let o of allOrders" [value]="o.id">
                PO #{{o.id}} - {{o.vendor?.name}} - {{o.createdon | date:'mediumDate'}}
              </option>
            </select>
            <small class="form-text text-muted">Select a PO to auto-populate vendor details</small>
          </div>
        </div>
      </div>
    </div>

<!-- Step 2: Document Upload & Auto-Extract (only show for new invoices) -->
<div *ngIf="!invoice.id">
  <div class="card border-primary mb-4">
    <div class="card-header bg-primary text-white">
      <h6 class="mb-0">
        <i class="bi bi-cloud-upload"></i> Step 2: Upload Invoice Document (Optional)
      </h6>
    </div>
    <div class="card-body">
      <div class="alert alert-info mb-3">
        <i class="bi bi-lightbulb"></i>
        <strong>Smart Entry:</strong> Upload your invoice document to automatically extract and populate
        document number, date, and line items. Review the extracted data and make any necessary adjustments.
      </div>
      <app-invoice-document-upload (dataExtracted)="handleExtractedData($event)"></app-invoice-document-upload>
    </div>
  </div>

  <!-- Visual Separator -->
  <div class="text-center my-4">
    <div class="d-inline-block px-3 py-2 bg-light border rounded">
      <i class="bi bi-arrow-down"></i>
      <span class="mx-2">OR enter manually below</span>
      <i class="bi bi-arrow-down"></i>
    </div>
  </div>
</div>

    <!-- Section 2: Document Information -->
    <div class="card bg-light mb-3">
      <div class="card-body">
        <h6 class="card-subtitle mb-3 text-primary">
          <i class="bi bi-file-text"></i> <span *ngIf="!invoice.id">Step 3: </span>Document Information
        </h6>

        <div class="row">
          <div class="col-md-3">
            <label for="vendor" class="form-label fw-bold">Vendor <span class="text-danger">*</span></label>
            <select class="form-select" id="vendor" formControlName="vendorid"
                    [class.is-invalid]="form.get('vendorid')?.invalid && form.get('vendorid')?.touched">
              <option value="">-- Select Vendor --</option>
              <option *ngFor="let v of vendors" [value]="v.id">{{v.name}}</option>
            </select>
            <small class="form-text text-muted" *ngIf="form.value.purchaseorderid">
              <i class="bi bi-check-circle text-success"></i> Auto-filled from PO
            </small>
            <div class="invalid-feedback" *ngIf="form.get('vendorid')?.errors?.['required']">
              Please select a vendor
            </div>

            <!-- Quick Add Vendor Button (shows when OCR doesn't find vendor) -->
            <div class="mt-2" *ngIf="vendorNotFound">
              <div class="alert alert-warning py-2 px-3 mb-2">
                <i class="bi bi-exclamation-triangle me-1"></i>
                <strong>{{ocrExtractedVendorName}}</strong> not found
              </div>
              <button type="button" class="btn btn-sm btn-primary w-100" (click)="openQuickAddVendor()">
                <i class="bi bi-plus-circle me-1"></i> Quick Add This Vendor
              </button>
            </div>
          </div>

          <div class="col-md-3">
            <label class="form-label fw-bold">Document Type <span class="text-danger">*</span></label>
            <div class="d-flex gap-3 mt-2">
              <div class="form-check">
                <input class="form-check-input" type="radio" formControlName="doctype"
                       id="doctypeInvoice" value="INVOICE">
                <label class="form-check-label" for="doctypeInvoice">
                  <i class="bi bi-receipt"></i> Invoice
                </label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" formControlName="doctype"
                       id="doctypeDeliveryChallan" value="DELIVERY_CHALLAN">
                <label class="form-check-label" for="doctypeDeliveryChallan">
                  <i class="bi bi-truck"></i> Challan
                </label>
              </div>
            </div>
          </div>

          <div class="col-md-3">
            <label for="invno" class="form-label fw-bold">Document No. <span class="text-danger">*</span></label>
            <input type="text" class="form-control" formControlName="invoiceno" id="invno"
                   maxlength="12" placeholder="e.g., INV-2024-001">
            <div *ngIf="form.controls['invoiceno'].dirty && form.controls['invoiceno'].invalid"
                 class="text-danger small mt-1">
              <i class="bi bi-exclamation-circle"></i> Alphanumeric with hyphen only
            </div>
          </div>

          <div class="col-md-3">
            <label for="invdate" class="form-label fw-bold">Document Date <span class="text-danger">*</span></label>
            <input type="date" class="form-control" formControlName="invoicedate" id="invdate">
          </div>
        </div>
      </div>
    </div>

    <!-- Error Message -->
    <div class="alert alert-danger alert-dismissible fade show" role="alert" *ngIf="errorMessage !== ''">
      <h6 class="alert-heading">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>Error Saving Invoice
      </h6>
      <p class="mb-0" style="white-space: pre-line;">{{errorMessage}}</p>
      <button type="button" class="btn-close" (click)="errorMessage = ''" aria-label="Close"></button>
    </div>

    <!-- Action Buttons -->
    <div class="row mt-4">
      <div class="col-md-12 d-flex gap-2 justify-content-between">
        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-primary px-4" [disabled]="!form.valid">
            <i class="bi bi-check-circle"></i> Save Invoice
          </button>
          <button type="button" (click)="gotoList()" class="btn btn-outline-secondary px-4">
            <i class="bi bi-x-circle"></i> Cancel
          </button>
        </div>
        <!-- Delete button (only shown when editing NEW invoices) -->
        <button *ngIf="invoice.id && invoice.status === 'NEW'" type="button" (click)="confirmDeleteInvoice()" class="btn btn-outline-danger px-4">
          <i class="bi bi-trash"></i> Delete Invoice
        </button>
      </div>
    </div>

</form>

<!-- Quick Add Vendor Dialog -->
<app-vendor-quick-add
  [(visible)]="showQuickAddVendor"
  [prefillName]="ocrExtractedVendorName"
  [prefillGstin]="ocrExtractedVendorGstin"
  (vendorCreated)="onVendorCreated($event)"
  (cancelled)="onQuickAddCancelled()">
</app-vendor-quick-add>

<!-- Delete Invoice Confirmation Dialog -->
<p-dialog header="Confirm Delete"
          [(visible)]="showDeleteInvoiceConfirm"
          [modal]="true"
          [style]="{width: '450px'}"
          [draggable]="false"
          [resizable]="false">
  <div class="p-fluid" *ngIf="invoice">
    <div class="mb-3 text-center">
      <i class="bi bi-exclamation-triangle-fill text-warning" style="font-size: 3rem;"></i>
      <p class="mt-3"><strong>Are you sure you want to delete this invoice?</strong></p>
      <p class="mb-0">Invoice No: <strong>{{invoice.invoiceno}}</strong></p>
      <p class="mb-0">Date: {{invoice.invoicedate | date:'dd/MM/yyyy'}}</p>
    </div>

    <div class="alert alert-warning">
      <i class="bi bi-info-circle me-2"></i>
      <strong>Warning:</strong> This action cannot be undone. If this invoice has items or payments, the deletion may fail.
    </div>
  </div>

  <ng-template pTemplate="footer">
    <button type="button" class="btn btn-secondary" (click)="cancelDeleteInvoice()">
      <i class="bi bi-x-circle me-1"></i>Cancel
    </button>
    <button type="button" class="btn btn-danger" (click)="deleteInvoice()">
      <i class="bi bi-trash me-1"></i>Delete Invoice
    </button>
  </ng-template>
</p-dialog>

<router-outlet></router-outlet>
</div>
</div>