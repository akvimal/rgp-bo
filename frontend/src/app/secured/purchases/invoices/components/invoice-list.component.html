<div class="row">
  <div class="col-12 mt-2">
    <a *isAuth="'purchases.add'" [routerLink]="['/secure/purchases/invoices/new']"><button class="btn btn-primary">Add New</button></a>
  </div>
  <div class="col-12">
    <p-table #dt1 [value]="invoices"
    [multiSortMeta]="[{field: 'invoicedate', order: -1}]"
    [resizableColumns]="true" columnResizeMode="expand" 
    [paginator]="true" [rows]="10" [showCurrentPageReport]="true" styleClass="p-datatable-gridlines mt-2"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries" 
        [rowsPerPageOptions]="[10,25,50]">
    <!-- <table *isAuth="'purchases.read'" class="table table-bordered mt-3"> -->
      <!-- <thead> -->
    <ng-template pTemplate="header">
    <tr>
      <th pSortableColumn="invoiceno">No.
        <p-sortIcon field="invoiceno"></p-sortIcon>
        <p-columnFilter type="text" field="invoiceno" display="menu"></p-columnFilter>
      </th>
      <th pSortableColumn="invoicedate">Date
        <p-sortIcon field="invoicedate"></p-sortIcon>
        <p-columnFilter type="date" field="invoicedate" display="menu"></p-columnFilter>
      </th>
      <th>Type</th>
      <th pSortableColumn="vendor.name">Vendor
        <p-sortIcon field="vendor.name"></p-sortIcon>
        <p-columnFilter type="text" field="vendor.name" display="menu"></p-columnFilter>
      </th>
      <th pSortableColumn="items">Items</th>
      <th pSortableColumn="total">Amount
        <p-sortIcon field="total"></p-sortIcon>
        <p-columnFilter type="numeric" field="total" display="menu"></p-columnFilter>
      </th>
      <th>Payment</th>
      <th>Tax</th>
      <th pSortableColumn="lifecyclestatus">Invoice Status
        <p-sortIcon field="lifecyclestatus"></p-sortIcon>
        <p-columnFilter type="text" field="lifecyclestatus" display="menu"></p-columnFilter>
      </th>
      <th>Actions</th>
    </tr>
  </ng-template>
  <!-- </thead>
  <tbody> -->
    <ng-template pTemplate="body" let-p>
      <tr>
        <td><a [routerLink]="['../items',p.id]">{{p.invoiceno}}</a></td>
        <td style="text-align: center;">{{p.invoicedate | date : 'dd/MM/yy'}}</td>
        <td>
          <span *ngIf="p.doctype === 'INVOICE'" class="badge bg-primary">INV</span>
          <span *ngIf="p.doctype === 'DELIVERY_CHALLAN'" class="badge bg-info">DC</span>
          <span *ngIf="!p.doctype" class="badge bg-secondary">-</span>
        </td>
        <td>{{p.vendor?.name}}</td>
        <td style="text-align: center;">{{p.items}}</td>
        <td style="text-align: right">{{p.total | number:'0.0-9'}}</td>
        <td>
          <span *ngIf="p.items > 0 && p.paymentstatus === 'PAID'" class="badge bg-success">Paid</span>
          <span *ngIf="p.items > 0 && p.paymentstatus === 'PARTIAL'"
                class="badge bg-warning text-dark"
                style="cursor: pointer;"
                (click)="openQuickPayment(p)"
                title="Click to complete payment">
            Partial <i class="bi bi-pencil-square ms-1"></i>
          </span>
          <span *ngIf="p.items > 0 && p.paymentstatus === 'UNPAID'"
                class="badge bg-danger"
                style="cursor: pointer;"
                (click)="openQuickPayment(p)"
                title="Click to mark as paid">
            Unpaid <i class="bi bi-pencil-square ms-1"></i>
          </span>
          <span *ngIf="!p.items || p.items === 0 || !p.paymentstatus" class="badge bg-secondary">-</span>
        </td>
        <td>
          <span *ngIf="p.items > 0 && p.taxstatus === 'RECONCILED'" class="badge bg-success">Done</span>
          <span *ngIf="p.items > 0 && p.taxstatus === 'CREDITED'" class="badge bg-info">Credit</span>
          <span *ngIf="p.items > 0 && p.taxstatus === 'FILED'" class="badge bg-primary">Filed</span>
          <span *ngIf="p.items > 0 && p.taxstatus === 'PENDING'" class="badge bg-warning text-dark">Pending</span>
          <span *ngIf="p.items > 0 && p.taxstatus === 'MISMATCH'" class="badge bg-danger">Mismatch</span>
          <span *ngIf="!p.items || p.items === 0 || !p.taxstatus" class="badge bg-secondary">-</span>
        </td>
        <td>
          <span *ngIf="p.lifecyclestatus === 'CLOSED'" class="badge bg-dark">Closed</span>
          <span *ngIf="p.lifecyclestatus === 'OPEN'" class="badge bg-success">Open</span>
          <span *ngIf="!p.lifecyclestatus" class="badge bg-secondary">-</span>
        </td>
        <td style="text-align: center;">
          <span *ngIf="p.lifecyclestatus === 'OPEN'">
            <a *isAuth="'purchases.edit'" [routerLink]="['../edit', p.id]" title="Edit Invoice">
              <i class="bi bi-pencil text-primary"></i>
            </a>
          </span>
          <span *ngIf="p.lifecyclestatus !== 'OPEN'" class="text-muted">
            <i class="bi bi-lock" title="Invoice is closed"></i>
          </span>
        </td>
      <!-- <td>
        <a (click)="delete(p.id)">
          <i class="bi bi-trash text-danger"></i>
        </a>
      </td> -->
    </tr>
  <!-- </tbody>
</table> -->
</ng-template>
</p-table>
  </div>
</div>
<p-dialog [header]="'Warning'" (onHide)="closeDeleteWarn()"
[(visible)]="displayError" [modal]="true">
    ERROR: {{errorMessage}}
</p-dialog>

<!-- Quick Payment Modal (Issue #61) -->
<p-dialog header="Mark Invoice as Paid"
          [(visible)]="showQuickPaymentDialog"
          [modal]="true"
          [style]="{width: '500px'}"
          [draggable]="false"
          [resizable]="false">
  <div class="p-fluid" *ngIf="selectedInvoice">
    <div class="mb-3">
      <p><strong>Invoice:</strong> {{selectedInvoice.invoiceno}}</p>
      <p><strong>Vendor:</strong> {{selectedInvoice.vendor?.name}}</p>
      <p><strong>Total Amount:</strong> â‚¹{{selectedInvoice.total | number:'1.2-2'}}</p>
      <p *ngIf="selectedInvoice.paymentstatus === 'PARTIAL'">
        <strong>Status:</strong> <span class="badge bg-warning text-dark">Partial Payment</span>
      </p>
    </div>

    <div class="mb-3">
      <label for="paymentMode" class="form-label">Payment Mode <span class="text-danger">*</span></label>
      <select id="paymentMode" class="form-select" [(ngModel)]="quickPaymentMode">
        <option value="CASH">Cash</option>
        <option value="CARD">Card</option>
        <option value="UPI">UPI</option>
        <option value="CHEQUE">Cheque</option>
        <option value="BANK_TRANSFER">Bank Transfer</option>
        <option value="OTHER">Other</option>
      </select>
    </div>

    <div class="mb-3">
      <label for="paymentDate" class="form-label">Payment Date</label>
      <input type="date"
             id="paymentDate"
             class="form-control"
             [(ngModel)]="quickPaymentDate"
             [max]="todayDate">
    </div>

    <div class="alert alert-info">
      <i class="bi bi-info-circle me-2"></i>
      This will create a payment record for the outstanding amount and mark the invoice as paid.
    </div>
  </div>

  <ng-template pTemplate="footer">
    <button type="button" class="btn btn-secondary" (click)="showQuickPaymentDialog = false">Cancel</button>
    <button type="button" class="btn btn-primary" (click)="confirmQuickPayment()" [disabled]="!quickPaymentMode">
      <i class="bi bi-check-circle me-1"></i>Mark as Paid
    </button>
  </ng-template>
</p-dialog>