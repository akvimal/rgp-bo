# Migration Renumbering - README

**Status:** üö® CRITICAL - Migration conflicts detected
**Action Required:** Execute renumbering before running any migrations
**Last Updated:** 2026-01-11

---

## ‚ö†Ô∏è IMPORTANT WARNING

**DO NOT execute migrations until renumbering is complete!**

The current migration directory contains **21 duplicate migration numbers** that will cause conflicts and unpredictable schema states.

---

## Quick Start

### 1. Review the Proposal
Read the complete renumbering proposal:
```bash
cat ../../docs/MIGRATION_RENUMBERING_PROPOSAL.md
```

### 2. Review the Migration Map
Quick reference for number changes:
```bash
cat MIGRATION_MAP.md
```

### 3. Execute Renumbering

**On Windows:**
```cmd
cd sql\migrations
MIGRATION_RENAME_COMMANDS.bat
```

**On Linux/Mac:**
```bash
cd sql/migrations
chmod +x MIGRATION_RENAME_COMMANDS.sh
./MIGRATION_RENAME_COMMANDS.sh
```

### 4. Verify Results
```bash
# Check for duplicate numbers (should return nothing)
ls -1 *.sql | sed 's/_.*//g' | sort | uniq -d

# View renamed files
git status
```

### 5. Test Migrations
Test on development database before committing:
```bash
# Create test database
docker exec -i rgp-db psql -U rgpapp -d postgres -c "CREATE DATABASE rgpdb_migration_test;"

# Run migrations in sequence
docker exec -i rgp-db psql -U rgpapp -d rgpdb_migration_test < 002_fix_bill_number_race_condition.sql
docker exec -i rgp-db psql -U rgpapp -d rgpdb_migration_test < 003_hr_management_tables.sql
# ... continue with all migrations in order

# Verify schema
docker exec -i rgp-db psql -U rgpapp -d rgpdb_migration_test -c "\dt"

# Clean up test database
docker exec -i rgp-db psql -U rgpapp -d postgres -c "DROP DATABASE rgpdb_migration_test;"
```

---

## Current Issues Summary

### Duplicate Migration Numbers

| Number | Count | Files |
|--------|-------|-------|
| 006 | 3 | invoice lifecycle, employment types, consolidated payroll |
| 007 | 2 | HSN tax master, salary components |
| 008 | 2 | pharmacy HSN codes, salary structure |
| 009 | 2 | product price, payroll tables |
| 010 | 2 | pricing rules, KPI enhancements |
| 011 | 2 | HSN permissions, payroll permissions |
| 012 | 3 | sales intent, GST rates, test data |
| 013 | 2 | comprehensive HSN, test data |
| 014 | 2 | ITC tracking, HSN codes |
| 015 | 2 | intent permissions, HSN codes |
| 016 | 4 | intent numbers, pack size bug, multi-store, test data |

**Total Conflicts:** 21 duplicate numbers across 31 migration files

---

## Renumbering Overview

### What Will Be Renamed

- **26 migration files** will be renumbered
- **1 deprecated file** will be archived
- **3 test data files** will be moved to `test_data/` directory

### What Stays the Same

- Migrations 002-005: No changes
- Migration 006 (invoice lifecycle): Kept as-is
- All rollback scripts maintain their migration numbers

### New Numbering Scheme

```
002-005   Infrastructure & Core
006-007   Purchase Invoice Lifecycle
008-015   HSN/Tax Management
016-018   Pricing Engine
019-022   Sales Intent System
023       Multi-Store Architecture
024-029   Payroll System
030-032   (Reserved for payroll enhancements)
033-034   Critical Bug Fixes
090-095   Test Data & Utilities
```

---

## Files Generated by Renumbering

### Documentation
- `../../docs/MIGRATION_RENUMBERING_PROPOSAL.md` - Complete proposal with rationale
- `MIGRATION_MAP.md` - Quick reference mapping old ‚Üí new numbers
- `README_RENUMBERING.md` - This file

### Scripts
- `MIGRATION_RENAME_COMMANDS.bat` - Windows renaming script
- `MIGRATION_RENAME_COMMANDS.sh` - Linux/Mac renaming script

### Directories Created
- `archive/deprecated/` - Deprecated migrations
- `test_data/` - Test data migrations (dev/test only)

---

## Post-Renumbering Tasks

### Immediate Tasks
- [ ] Verify all renames completed successfully
- [ ] Check git status for staged changes
- [ ] Review no files were missed
- [ ] Test migration sequence on dev database

### Short-Term Tasks
- [ ] Create missing rollback scripts
- [ ] Update migration tracking table
- [ ] Document which migrations are already applied in each environment
- [ ] Update any references to old migration numbers in code/docs

### Long-Term Tasks
- [ ] Implement automated migration versioning
- [ ] Add pre-commit hooks to prevent duplicate numbers
- [ ] Create migration dependency checker
- [ ] Set up CI/CD migration testing

---

## Migration Categories Explained

### Infrastructure & Core (002-005)
Foundation migrations that other features depend on.
- Race condition fixes
- HR management tables
- Test database setup
- Basic permissions

### Purchase Invoice Lifecycle (006-007)
Enhanced invoice management with OCR, tax tracking, and lifecycle states.

### HSN/Tax Management (008-015)
Complete GST/HSN code management system.
- HSN tax master tables
- Pharmacy HSN code populations
- GST rate updates for 2025
- ITC (Input Tax Credit) tracking

### Pricing Engine (016-018)
Advanced product pricing with rules engine.
- Enhanced pricing table
- Pricing rules and automation

### Sales Intent System (019-022)
Customer product requests and sales staff intent capture.
- Intent creation
- Multi-product support
- Intent number generation
- Permissions

### Multi-Store Architecture (023)
Multi-tenant, multi-store support with tenant/store tables.

### Payroll System (024-029)
Complete flexible payroll system.
- Employment types and roles
- Salary components
- Salary structure
- Payroll processing
- KPI tracking
- Permissions

### Critical Bug Fixes (033-034)
Production bug fixes that must be applied.
- **033:** Pack size historical quantity bug (CRITICAL)

### Test Data (090-095)
Sample data for development/testing only.
- ‚ö†Ô∏è **DO NOT RUN IN PRODUCTION**

---

## Execution Priorities

### Critical Path (Must Run)
```
002 ‚Üí 006 ‚Üí 033
```
These fix critical bugs and enhance core invoice functionality.

### Business Features (As Needed)
- HSN/Tax: 008-015 (if using GST)
- Pricing: 016-017 (if using advanced pricing)
- Sales Intent: 019-022 (if using customer request system)
- Multi-Store: 023 (if operating multiple stores)

### Payroll System (If Implementing Payroll)
```
024 ‚Üí 025 ‚Üí 026 ‚Üí 027 ‚Üí 028 ‚Üí 029
```

---

## Common Questions

### Q: Which migrations are already applied to our database?
**A:** Check your migration tracking table or run:
```sql
SELECT tablename FROM pg_tables
WHERE schemaname = 'public'
ORDER BY tablename;
```
Match tables to migration features.

### Q: Can I skip migrations?
**A:** Only if you don't need those features AND they don't have dependencies. Check the dependency graph in MIGRATION_MAP.md.

### Q: What if a migration fails?
**A:**
1. Don't panic - most migrations are wrapped in transactions
2. Check the error message
3. Run the corresponding rollback script if available
4. Fix the issue
5. Retry the migration

### Q: Should I run test data migrations in production?
**A:** **NO!** Test data migrations (090-092) are for development/testing only. They may delete production data.

---

## Need Help?

### Resources
1. **Proposal Document:** `../../docs/MIGRATION_RENUMBERING_PROPOSAL.md`
2. **Migration Map:** `MIGRATION_MAP.md`
3. **Original Analysis:** Review git commit messages
4. **Individual Migration Files:** Each contains detailed comments

### Before Running Migrations
1. ‚úÖ Backup your database
2. ‚úÖ Review the migration SQL
3. ‚úÖ Test on development database first
4. ‚úÖ Ensure rollback script exists
5. ‚úÖ Understand what the migration does

### If Things Go Wrong
1. Check logs for error messages
2. Run corresponding rollback script
3. Review migration file for issues
4. Consult with team before retrying

---

## Status Tracking

### Pre-Renumbering
- [x] Analyze migration conflicts
- [x] Create renumbering proposal
- [x] Generate rename scripts
- [x] Document migration map
- [ ] Team review
- [ ] Approval

### Post-Renumbering
- [ ] Execute rename scripts
- [ ] Verify file structure
- [ ] Test migrations on dev database
- [ ] Create missing rollback scripts
- [ ] Update migration tracking
- [ ] Commit changes
- [ ] Deploy to production

---

**Last Updated:** 2026-01-11
**Maintainer:** Development Team
**Review Status:** Awaiting Approval
